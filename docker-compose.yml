version: '3.8'

services:
  homeassistant:
    image: "ghcr.io/home-assistant/home-assistant:${HOMEASSISTANT_VERSION}"
    volumes:
      - homeassistant_config:/config
      - /etc/localtime:/etc/localtime:ro
      - /run/dbus:/run/dbus:ro # Mount the D-Bus socket
    restart: unless-stopped
    privileged: true
    cap_add:
      - NET_ADMIN
      - NET_RAW
    networks:
      - home
      - traefik_public
    labels:
      # Traefik Public Domain Configuration
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_public"
      - "traefik.http.routers.homeassistant-public.rule=Host(`${PUBLIC_DOMAIN}`)"
      - "traefik.http.routers.homeassistant-public.entrypoints=${TRAEFIK_ENTRYPOINT_WEB_SECURE}"
      - "traefik.http.routers.homeassistant-public.service=homeassistant-service"
      - "traefik.http.routers.homeassistant-public.tls=true"
      - "traefik.http.routers.homeassistant-public.tls.certresolver=letsencrypt"
      
      # Traefik Private Domain Configuration
      - "traefik.http.routers.homeassistant-private.rule=Host(`${PRIVATE_DOMAIN}`)"
      - "traefik.http.routers.homeassistant-private.entrypoints=${TRAEFIK_ENTRYPOINT_WEB_SECURE}"
      - "traefik.http.routers.homeassistant-private.service=homeassistant-service"
      - "traefik.http.routers.homeassistant-private.tls=true"
      
      # Service Configuration
      - "traefik.http.services.homeassistant-service.loadbalancer.server.port=${HOMEASSISTANT_PORT}"
      
      # Middleware for Security
      - "traefik.http.routers.homeassistant-public.middlewares=homeassistant-security@docker"
      - "traefik.http.middlewares.homeassistant-security.headers.sslredirect=true"
      - "traefik.http.middlewares.homeassistant-security.headers.stsincludesubdomains=true"
      - "traefik.http.middlewares.homeassistant-security.headers.stspreload=true"
      - "traefik.http.middlewares.homeassistant-security.headers.stsseconds=31536000"
      - "traefik.http.middlewares.homeassistant-security.headers.customrequestheaders.X-Forwarded-Proto=https"

    environment:
      - TZ=America/New_York
      # Reverse Proxy Configuration for Traefik
      - HASS_HTTP_TRUSTED_PROXY_1=172.16.0.0/12
      - HASS_HTTP_TRUSTED_PROXY_2=192.168.0.0/16
      - HASS_HTTP_TRUSTED_PROXY_3=10.0.0.0/8
      - HASS_HTTP_USE_X_FORWARDED_FOR=true

  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    restart: unless-stopped
    networks:
      - home
    deploy:
      replicas: ${CLOUDFLARED_REPLICA_COUNT}
    depends_on:
      - homeassistant

  matter-server:
    image: ghcr.io/home-assistant-libs/python-matter-server:stable
    restart: unless-stopped
    security_opt:
      - apparmor:unconfined
    volumes:
      - matter_data:/data
      - /run/dbus:/run/dbus:ro
    networks:
      - home
    ports:
      - "${MATTER_SERVER_PORT}:5580"
    environment:
      - MATTER_SERVER_LOG_LEVEL=${MATTER_SERVER_LOG_LEVEL}

networks:
  home:
    external: true
  traefik_public:
    external: true

volumes:
  homeassistant_config:
    driver: local
  matter_data:
    driver: local
  stack:
    


