version: '3.8'

services:
  homeassistant:
    image: "ghcr.io/home-assistant/home-assistant:${HOMEASSISTANT_VERSION}"
    volumes:
      - homeassistant_config:/config
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped
    privileged: true
    networks:
      - home
      - traefik_public
      - stack
    labels:
      # Traefik Public Domain Configuration
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_public"
      - "traefik.http.routers.homeassistant-public.rule=Host(`${PUBLIC_DOMAIN}`)"
      - "traefik.http.routers.homeassistant-public.entrypoints=${TRAEFIK_ENTRYPOINT_WEB_SECURE}"
      - "traefik.http.routers.homeassistant-public.service=homeassistant-service"
      - "traefik.http.routers.homeassistant-public.tls=true"
      - "traefik.http.routers.homeassistant-public.tls.certresolver=letsencrypt"
      
      # Traefik Private Domain Configuration
      - "traefik.http.routers.homeassistant-private.rule=Host(`${PRIVATE_DOMAIN}`)"
      - "traefik.http.routers.homeassistant-private.entrypoints=${TRAEFIK_ENTRYPOINT_WEB_SECURE}"
      - "traefik.http.routers.homeassistant-private.service=homeassistant-service"
      - "traefik.http.routers.homeassistant-private.tls=true"
      
      # Service Configuration
      - "traefik.http.services.homeassistant-service.loadbalancer.server.port=${HOMEASSISTANT_PORT}"
      
      # Middleware for Security
      - "traefik.http.routers.homeassistant-public.middlewares=homeassistant-security@docker"
      - "traefik.http.middlewares.homeassistant-security.headers.sslredirect=true"
      - "traefik.http.middlewares.homeassistant-security.headers.stsincludesubdomains=true"
      - "traefik.http.middlewares.homeassistant-security.headers.stspreload=true"
      - "traefik.http.middlewares.homeassistant-security.headers.stsseconds=31536000"
      - "traefik.http.middlewares.homeassistant-security.headers.customrequestheaders.X-Forwarded-Proto=https"

    environment:
      - TZ=America/New_York

  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    restart: unless-stopped
    networks:
      - stack
    deploy:
      replicas: ${CLOUDFLARED_REPLICA_COUNT}
    depends_on:
      - homeassistant

networks:
  home:
    external: true
  traefik_public:
    external: true
  stack:
    

volumes:
  homeassistant_config:
    driver: local
